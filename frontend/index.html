<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ—É–Ω–Ω—ã–π –¥–µ–Ω—å —Å–µ–≥–æ–¥–Ω—è</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>üåô –õ—É–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</h1>
        
        <div class="sky-container">
            <div class="stars"></div>
        <div class="clouds"></div>
        <div class="moon-hidden" id="moonHidden">
            <div class="moon" id="moon"></div>
        </div>
    </div>

    <button class="btn" id="getMoonDayBtn">–õ—É–Ω–Ω—ã–π –¥–µ–Ω—å —Å–µ–≥–æ–¥–Ω—è</button>

    <div class="result" id="result">
        <div class="initial-message">
            <div class="welcome">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ª—É–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å!</div>
            <div class="instruction">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Ç–µ–∫—É—â–∏–π –ª—É–Ω–Ω—ã–π –¥–µ–Ω—å</div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const stars = document.querySelector('.stars');
        const clouds = document.querySelector('.clouds');
        const moonHidden = document.getElementById('moonHidden');
        const moon = document.getElementById('moon');
        const btn = document.getElementById('getMoonDayBtn');
        const result = document.getElementById('result');

        let isAnimationInProgress = false;

        function createStars() {
            const starsCount = 100;
            for (let i = 0; i < starsCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (Math.random() * 2 + 1) + 's';
                stars.appendChild(star);
            }
        }

        function createClouds() {
            const cloudPositions = [
                {left: '10%', top: '20%', size: '60px', delay: '0s'},
                {left: '70%', top: '30%', size: '80px', delay: '1s'},
                {left: '30%', top: '60%', size: '100px', delay: '2s'},
                {left: '80%', top: '70%', size: '70px', delay: '1.5s'},
                {left: '20%', top: '80%', size: '90px', delay: '0.5s'}
            ];

            cloudPositions.forEach(pos => {
                const cloud = document.createElement('div');
                cloud.className = 'cloud';
                cloud.style.left = pos.left;
                cloud.style.top = pos.top;
                cloud.style.width = pos.size;
                cloud.style.height = pos.size;
                cloud.style.animationDelay = pos.delay;
                clouds.appendChild(cloud);
            });
        }

        function revealMoon(illumination) {
            return new Promise((resolve) => {
                isAnimationInProgress = true;
                
                clouds.style.animation = 'cloudsDisappear 2s forwards';
                
                moonHidden.style.opacity = '1';
                moonHidden.style.transform = 'translate(-50%, -50%) scale(1)';
                
                setMoonPhase(illumination);
                setTimeout(() => {
                    stars.style.opacity = '0.3';
                }, 1000);
                setTimeout(() => {
                    isAnimationInProgress = false;
                    resolve();
                }, 2000);
            });
        }

        function setMoonPhase(illumination) {
            moon.style.boxShadow = '';
            const shadowPosition = Math.abs(50 - illumination) * 3;
            
            if (illumination === 0) {
                moon.style.boxShadow = 'inset 0 0 0 150px #1a1a3a';
            } else if (illumination === 100) {
                moon.style.boxShadow = '0 0 40px rgba(255, 255, 255, 0.4)';
            } else if (illumination > 50) {
                moon.style.boxShadow = `inset ${shadowPosition}px 0 0 0 #1a1a3a, 0 0 40px rgba(255, 255, 255, 0.4)`;
            } else {
                moon.style.boxShadow = `inset -${shadowPosition}px 0 0 0 #1a1a3a, 0 0 40px rgba(255, 255, 255, 0.4)`;
            }
        }

        async function getMoonData() {
            const now = new Date();

            const params = {
                utc: -Math.round(now.getTimezoneOffset() / 60),
                day: now.getDate(),
                month: now.getMonth() + 1,
                year: now.getFullYear(),
                hour: now.getHours(),
                minute: now.getMinutes(),
                second: now.getSeconds()
            };

            const url = new URL('https://moon.qoph.org/v1/moonPhaseDate');
            Object.entries(params).forEach(([key, value]) => {
                url.searchParams.append(key, value.toString());
            });

            console.log('–ó–∞–ø—Ä–æ—Å –∫ API:', url.toString());

            const response = await fetch(url.toString(), {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            });

            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ API: ${response.status} ${response.statusText}`);
            }
            return await response.json();
        }

        btn.addEventListener('click', async function() {
            if (isAnimationInProgress) return;
            
            startLoading();
            try {
                const moonData = await getMoonData();
                console.log('–û—Ç–≤–µ—Ç API:', moonData);
                
                await revealMoon(moonData.CurrentState.Illumination);
                
                handleSuccessResponse(moonData);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                handleError(error);
            }
        });

        function startLoading() {
            btn.disabled = true;
            result.innerHTML = '<div class="loading-text">–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ª—É–Ω–Ω–æ–º—É API...</div>';
        }

        function stopLoading() {
            btn.disabled = false;
        }

        function handleSuccessResponse(moonData) {
            const moonDay = Math.floor(moonData.CurrentState.MoonDays);
            const illumination = moonData.CurrentState.Illumination.toFixed(1);
            const phase = moonData.CurrentState.Phase;
            const zodiac = moonData.CurrentState.Zodiac;

            result.innerHTML = `
                <div class="moon-day">–°–µ–≥–æ–¥–Ω—è <span class="highlight">${moonDay}</span> –ª—É–Ω–Ω—ã–π –¥–µ–Ω—å</div>
                <div class="moon-details">
                    <div class="detail-item">
                        <span class="detail-label">–§–∞–∑–∞:</span>
                        <span class="detail-value">${phase.Emoji} ${phase.Name}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">–ó–Ω–∞–∫:</span>
                        <span class="detail-value">${zodiac.Emoji} ${zodiac.Name}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">–û—Å–≤–µ—â–µ–Ω–∏–µ:</span>
                        <span class="detail-value">${illumination}%</span>
                    </div>
                </div>
            `;
            result.className = 'result success';
            
            stopLoading();
        }

        function handleError(error) {
            result.innerHTML = `
                <div class="error-title">–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</div>
                <div class="error-detail">${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>
                <div class="error-hint">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –µ—â–µ —Ä–∞–∑</div>
            `;
            result.className = 'result error';
            
            stopLoading();
        }

        createStars();
        createClouds();
    });
</script>
</body>
</html>